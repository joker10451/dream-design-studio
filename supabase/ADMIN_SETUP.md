# Создание и тестирование админ аккаунта

## Обзор

Этот документ описывает, как создать тестовые аккаунты с разными ролями для тестирования системы Smart Home 2026.

## Проблема с внешними ключами

Таблица `user_profiles` имеет внешний ключ на `auth.users(id)`. Это означает, что нельзя создать профиль без соответствующей записи в `auth.users`.

## Решения

### Способ 1: Использовать реальных пользователей (Рекомендуется)

1. **Создайте пользователя через Supabase Auth UI**:
   - Откройте Supabase Dashboard → Authentication → Users
   - Нажмите "Add user" 
   - Введите email и пароль
   - Подтвердите email (если требуется)

2. **Выполните скрипт** `create_admin_user.sql`
   - Скрипт автоматически найдет первого пользователя
   - Обновит его роль до админа
   - Создаст соответствующий профиль

### Способ 2: Тестовые профили без аутентификации

Скрипт временно отключает проверку внешних ключей и создает тестовые профили:

⚠️ **ВАЖНО**: Эти профили нельзя использовать для входа в систему!

## Файлы

- `create_admin_user.sql` - Создание тестовых пользователей
- `test_rls_policies.sql` - Тестирование RLS политик  
- `ADMIN_SETUP.md` - Эта инструкция

## Шаг 1: Создание пользователей

### Вариант А: Через Supabase Auth UI (Рекомендуется)

1. Supabase Dashboard → Authentication → Users → "Add user"
2. Email: `admin@test.com`, Password: `admin123!`
3. Выполните `create_admin_user.sql`

### Вариант Б: Только тестовые профили

Выполните `create_admin_user.sql` - он создаст профили с отключенной проверкой FK.

## Шаг 2: Проверка созданных пользователей

После выполнения скрипта проверьте результат:

```sql
SELECT 
  id,
  username,
  full_name,
  role,
  created_at,
  CASE 
    WHEN EXISTS (SELECT 1 FROM auth.users WHERE auth.users.id = user_profiles.id) 
    THEN 'Реальный пользователь' 
    ELSE 'Тестовый профиль' 
  END as auth_status
FROM public.user_profiles
ORDER BY role;
```

## Шаг 3: Тестирование RLS политик

Выполните скрипт `test_rls_policies.sql` для проверки всех функций.

## Использование в приложении

### Для реальных пользователей
Используйте обычную аутентификацию Supabase:

```javascript
const { data, error } = await supabase.auth.signInWithPassword({
  email: 'admin@test.com',
  password: 'admin123!'
});
```

### Для тестирования RLS в SQL
```sql
-- Установить контекст (используйте реальный ID пользователя)
SET LOCAL "request.jwt.claims" = '{"sub": "real-user-id-here"}';

-- Или для тестовых профилей
SET LOCAL "request.jwt.claims" = '{"sub": "00000000-0000-0000-0000-000000000001"}';
```

## Тестовые ID (только для RLS тестирования)

- **Админ**: `00000000-0000-0000-0000-000000000001`
- **Модератор**: `00000000-0000-0000-0000-000000000002`  
- **Пользователь**: `00000000-0000-0000-0000-000000000003`

## Роли и права доступа

### Админ (`admin`)
- Полный доступ ко всем данным
- Может управлять пользователями, продуктами, категориями
- Видит все системные настройки и логи

### Модератор (`moderator`)  
- Может управлять продуктами и контентом
- Может модерировать отзывы
- Не может управлять пользователями

### Пользователь (`user`)
- Видит только публичные данные
- Может управлять своими данными (избранное, списки)

## Troubleshooting

### Ошибка: "violates foreign key constraint"
**Причина**: Нет записи в `auth.users`
**Решение**: Создайте пользователя через Auth UI или используйте способ 2

### Ошибка: "permission denied for schema auth"
**Причина**: Недостаточно прав для изменения `auth.users`
**Решение**: Используйте Supabase Dashboard для создания пользователей

### Функции ролей не работают
**Решение**: Убедитесь, что функции созданы в схеме `public`:
```sql
SELECT proname FROM pg_proc WHERE proname LIKE '%admin%';
```

## Очистка тестовых данных

```sql
-- Удалить тестовые профили
DELETE FROM public.user_profiles 
WHERE id IN (
  '00000000-0000-0000-0000-000000000001',
  '00000000-0000-0000-0000-000000000002', 
  '00000000-0000-0000-0000-000000000003'
);

-- Удалить реальных пользователей через Auth UI
```