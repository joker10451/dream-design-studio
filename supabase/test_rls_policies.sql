-- Тестирование RLS политик с разными ролями пользователей
-- Выполните этот скрипт в SQL Editor вашего Supabase проекта

-- =====================================================
-- ТЕСТИРОВАНИЕ RLS ПОЛИТИК
-- =====================================================

-- Тестовые ID пользователей
-- АДМИН:      00000000-0000-0000-0000-000000000001
-- МОДЕРАТОР:  00000000-0000-0000-0000-000000000002
-- ПОЛЬЗОВАТЕЛЬ: 00000000-0000-0000-0000-000000000003

-- =====================================================
-- ТЕСТ 1: ПРОВЕРКА ФУНКЦИЙ РОЛЕЙ
-- =====================================================

DO $$
BEGIN
  RAISE NOTICE '=== ТЕСТ 1: Проверка функций ролей ===';
END;
$$;

-- Установить контекст админа
SET LOCAL "request.jwt.claims" = '{"sub": "00000000-0000-0000-0000-000000000001"}';

-- Проверить функции ролей для админа
SELECT 
  'АДМИН' as user_type,
  public.user_role() as role,
  public.is_admin() as is_admin,
  public.is_admin_or_moderator() as is_admin_or_moderator;

-- Установить контекст модератора
SET LOCAL "request.jwt.claims" = '{"sub": "00000000-0000-0000-0000-000000000002"}';

-- Проверить функции ролей для модератора
SELECT 
  'МОДЕРАТОР' as user_type,
  public.user_role() as role,
  public.is_admin() as is_admin,
  public.is_admin_or_moderator() as is_admin_or_moderator;

-- Установить контекст обычного пользователя
SET LOCAL "request.jwt.claims" = '{"sub": "00000000-0000-0000-0000-000000000003"}';

-- Проверить функции ролей для пользователя
SELECT 
  'ПОЛЬЗОВАТЕЛЬ' as user_type,
  public.user_role() as role,
  public.is_admin() as is_admin,
  public.is_admin_or_moderator() as is_admin_or_moderator;

-- =====================================================
-- ТЕСТ 2: ДОСТУП К ПРОФИЛЯМ
-- =====================================================

DO $$
BEGIN
  RAISE NOTICE '=== ТЕСТ 2: Доступ к профилям ===';
END;
$$;

-- Тест как обычный пользователь
SET LOCAL "request.jwt.claims" = '{"sub": "00000000-0000-0000-0000-000000000003"}';

-- Пользователь должен видеть только свой профиль
SELECT 
  'Пользователь видит профили:' as test,
  COUNT(*) as count
FROM user_profiles;

-- Тест как админ
SET LOCAL "request.jwt.claims" = '{"sub": "00000000-0000-0000-0000-000000000001"}';

-- Админ должен видеть все профили
SELECT 
  'Админ видит профили:' as test,
  COUNT(*) as count
FROM user_profiles;

-- =====================================================
-- ТЕСТ 3: УПРАВЛЕНИЕ ПРОДУКТАМИ
-- =====================================================

DO $$
BEGIN
  RAISE NOTICE '=== ТЕСТ 3: Управление продуктами ===';
END;
$$;

-- Создать тестовый продукт как админ
SET LOCAL "request.jwt.claims" = '{"sub": "00000000-0000-0000-0000-000000000001"}';

INSERT INTO products (
  name,
  slug,
  description,
  price,
  is_active,
  created_by
) VALUES (
  'Тестовый продукт',
  'test-product',
  'Продукт для тестирования RLS',
  1000.00,
  true,
  '00000000-0000-0000-0000-000000000001'
) ON CONFLICT (slug) DO UPDATE SET
  name = EXCLUDED.name,
  updated_at = NOW(),
  updated_by = '00000000-0000-0000-0000-000000000001';

-- Проверить, что все пользователи видят активные продукты
SET LOCAL "request.jwt.claims" = '{"sub": "00000000-0000-0000-0000-000000000003"}';

SELECT 
  'Пользователь видит продукты:' as test,
  COUNT(*) as count
FROM products;

-- =====================================================
-- ТЕСТ 4: СОЗДАНИЕ ИЗБРАННОГО
-- =====================================================

DO $$
BEGIN
  RAISE NOTICE '=== ТЕСТ 4: Избранные товары ===';
END;
$$;

-- Пользователь добавляет товар в избранное
SET LOCAL "request.jwt.claims" = '{"sub": "00000000-0000-0000-0000-000000000003"}';

INSERT INTO user_favorites (
  user_id,
  product_id
)
SELECT 
  '00000000-0000-0000-0000-000000000003',
  id
FROM products 
WHERE slug = 'test-product'
LIMIT 1
ON CONFLICT (user_id, product_id) DO NOTHING;

-- Проверить, что пользователь видит свои избранные
SELECT 
  'Пользователь видит избранных:' as test,
  COUNT(*) as count
FROM user_favorites;

-- Проверить, что другой пользователь не видит чужие избранные
SET LOCAL "request.jwt.claims" = '{"sub": "00000000-0000-0000-0000-000000000002"}';

SELECT 
  'Модератор видит избранных (должно быть 0):' as test,
  COUNT(*) as count
FROM user_favorites;

-- =====================================================
-- ТЕСТ 5: СИСТЕМНЫЕ НАСТРОЙКИ
-- =====================================================

DO $$
BEGIN
  RAISE NOTICE '=== ТЕСТ 5: Системные настройки ===';
END;
$$;

-- Обычный пользователь должен видеть только публичные настройки
SET LOCAL "request.jwt.claims" = '{"sub": "00000000-0000-0000-0000-000000000003"}';

SELECT 
  'Пользователь видит настроек:' as test,
  COUNT(*) as count
FROM system_settings;

-- Админ должен видеть все настройки
SET LOCAL "request.jwt.claims" = '{"sub": "00000000-0000-0000-0000-000000000001"}';

SELECT 
  'Админ видит настроек:' as test,
  COUNT(*) as count
FROM system_settings;

-- =====================================================
-- ОЧИСТКА ТЕСТОВЫХ ДАННЫХ
-- =====================================================

DO $$
BEGIN
  RAISE NOTICE '=== ОЧИСТКА ТЕСТОВЫХ ДАННЫХ ===';
END;
$$;

-- Установить контекст админа для очистки
SET LOCAL "request.jwt.claims" = '{"sub": "00000000-0000-0000-0000-000000000001"}';

-- Удалить тестовые данные
DELETE FROM user_favorites WHERE user_id IN (
  '00000000-0000-0000-0000-000000000001',
  '00000000-0000-0000-0000-000000000002',
  '00000000-0000-0000-0000-000000000003'
);

DELETE FROM products WHERE slug = 'test-product';

-- Сбросить контекст
RESET "request.jwt.claims";

DO $$
BEGIN
  RAISE NOTICE '=================================================';
  RAISE NOTICE 'ТЕСТИРОВАНИЕ RLS ПОЛИТИК ЗАВЕРШЕНО!';
  RAISE NOTICE '=================================================';
  RAISE NOTICE '';
  RAISE NOTICE 'Проверьте результаты выше:';
  RAISE NOTICE '- Функции ролей работают корректно';
  RAISE NOTICE '- Пользователи видят только свои данные';
  RAISE NOTICE '- Админы имеют полный доступ';
  RAISE NOTICE '- Модераторы имеют расширенные права';
  RAISE NOTICE '';
END;
$$;