# Supabase Setup Guide

## Обзор

Этот проект использует Supabase в качестве Backend-as-a-Service для управления базой данных, аутентификацией и real-time функциями.

## Быстрый старт

### 1. Настройка переменных окружения

Убедитесь, что в файле `.env` настроены следующие переменные:

```env
# Supabase Configuration
VITE_SUPABASE_URL=your_supabase_project_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### 2. Применение миграций

**ВАЖНО:** Миграции должны быть применены через Supabase Dashboard, а не через CLI.

1. Откройте ваш проект в [Supabase Dashboard](https://supabase.com/dashboard)
2. Перейдите в раздел **SQL Editor**
3. Скопируйте содержимое файла `supabase/apply_migrations.sql`
4. Вставьте в SQL Editor и нажмите **Run**

Миграция создаст:
- ✅ 19 основных таблиц
- ✅ 4 пользовательских типа (ENUM)
- ✅ 50+ оптимизированных индексов
- ✅ Политики Row Level Security
- ✅ Функции поиска и рекомендаций
- ✅ Триггеры для автоматизации
- ✅ Начальные данные (категории и бренды)

### 3. Проверка подключения

После применения миграций:

1. Запустите приложение: `npm run dev`
2. Перейдите на страницу тестирования: `http://localhost:8080/supabase-test`
3. Проверьте все тесты подключения

### 4. Запуск тестов

```bash
npm test
```

Все 156 тестов должны проходить успешно.

## Структура базы данных

### Основные таблицы

- **user_profiles** - Расширенные профили пользователей
- **categories** - Категории продуктов с иерархией
- **brands** - Бренды производителей
- **products** - Каталог продуктов умного дома
- **product_images** - Изображения продуктов
- **affiliate_links** - Партнерские ссылки на маркетплейсы
- **articles** - Статьи, новости, обзоры
- **user_favorites** - Избранные товары пользователей
- **shopping_lists** - Списки покупок
- **user_product_views** - История просмотров
- **analytics_events** - События для аналитики
- **newsletter_subscribers** - Подписчики рассылки
- **product_reviews** - Отзывы на продукты
- **user_notifications** - Уведомления пользователей
- **system_settings** - Настройки системы
- **system_logs** - Системные логи

### API Сервисы

- **productsApi** - Управление продуктами
- **categoriesApi** - Управление категориями
- **brandsApi** - Управление брендами

### React Query Хуки

- **useProducts()** - Получение продуктов с фильтрацией
- **useCategories()** - Получение категорий
- **useBrands()** - Получение брендов
- **useAuth()** - Аутентификация пользователя

## Безопасность

Проект использует Row Level Security (RLS) для защиты данных:

- Публичный доступ к активным продуктам, категориям, брендам
- Пользователи могут управлять только своими данными
- Админы имеют полный доступ к управлению контентом
- Анонимные пользователи могут отправлять аналитику

## Функции поиска

База данных включает продвинутые функции:

- **search_products()** - Полнотекстовый поиск с фильтрацией
- **get_user_recommendations()** - Персонализированные рекомендации
- **get_popular_products()** - Популярные продукты за период

## Мониторинг

- Системные логи записываются в таблицу `system_logs`
- Аналитические события в `analytics_events`
- Автоматическая очистка старых данных (функция `cleanup_old_analytics`)

## Troubleshooting

### Ошибка подключения

1. Проверьте переменные окружения в `.env`
2. Убедитесь, что Supabase проект активен
3. Проверьте правильность URL и ключей

### Ошибки миграции

1. Убедитесь, что используете SQL Editor в Dashboard
2. Проверьте права доступа к проекту
3. Примените миграции по порядку

### Ошибки RLS

1. Проверьте, что политики применены корректно
2. Убедитесь в правильности ролей пользователей
3. Проверьте функции аутентификации

## Дополнительные команды

```bash
# Запуск в режиме разработки
npm run dev

# Сборка для продакшена
npm run build

# Запуск тестов
npm test

# Запуск тестов в watch режиме
npm run test:watch
```

## Поддержка

При возникновении проблем:

1. Проверьте страницу тестирования `/supabase-test`
2. Изучите логи в консоли браузера
3. Проверьте Supabase Dashboard на наличие ошибок

## Следующие шаги

После успешного применения миграций можно переходить к:

1. **Task 2.1**: Базовая интеграция Supabase клиента ✅ (завершено)
2. **Task 2.2**: API сервисы для продуктов ✅ (завершено)
3. **Task 2.3**: Миграция существующих данных
4. **Task 3.1**: Настройка Supabase Auth
5. **Task 3.2**: Пользовательские функции (избранное, списки)

Текущий статус: **Task 1.2 ЗАВЕРШЕН** - База данных готова к использованию!